#!/usr/bin/env python

import os, os.path
import email
from pprint import pprint

outfile = 'INDEX'

def main(args):
    results = dict()
    for root, dirs, files in os.walk('.'):
        #print 'Scanning "%s"...' % (root)
        # ignore hidden dirs like '.bzr' and '.git'
        for d in dirs:
            #print 'Dir %s' % (d)
            if d.startswith('.'):
                dirs.remove(d)
                #print 'Removing %s' % (d)
        if root == '.':
            continue
        if 'meta' in files:
            path = os.path.join(root, 'meta')
            parse(path, results)
        else:
            # Warn if there's no meta in a leaf dir
            if not dirs:
                print 'No "meta" file in %s' % (root)

    lines = [
            'Do not edit this file.  Edit the "meta" files in sub-directories instead,',
            'and run generate-index.py to rebuild this file.',
            ]
    lines.extend(summarize(results))
    lines.append('')
    print '=========='
    print '\n'.join(lines)
    fp = open(outfile, 'w')
    fp.write('\n'.join(lines))
    fp.close()
    print 'Wrote %i lines to %s' % (len(lines), outfile)

def parse(path, results):
    #print 'Parsing "%s"...' % (path)
    msg = email.message_from_file(open(path))
    #pprint(msg.items())

    path = os.path.dirname(path)
    if path.startswith('./'):
        path = path[2:]

    for k,v in msg.items():
        if k.strip() in ('', 'Description', ):
            continue
        for v2 in v.split(', '):
            if v2.strip() in ('', ):
                continue
            key = (k,v2)
            if key not in results:
                results[key] = []
            results[key].append(path)

def summarize(results):
    lines = []
    keys = results.keys()
    keys.sort()
    prev_lk = ''
    for lk,rk in keys:
        if lk != prev_lk:
            lines.append('')
            lines.append('%s' % (lk))
        prev_lk = lk
        lines.append('')
        lines.append('    %s:' % (rk))
        for v in results[(lk,rk)]:
            lines.append('        %s' % (v))

    return lines

if __name__ == "__main__":
    import sys
    main(sys.argv[1:])

